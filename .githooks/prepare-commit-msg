#!/usr/bin/env bash
# 自动格式化 vibe-kanban 风格的 commit message
# 支持 merge commit 格式化

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

if [ -f "$COMMIT_MSG_FILE" ]; then
    ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")

    # 处理 merge commit
    if [ "$COMMIT_SOURCE" = "merge" ]; then
        # 提取被合并的分支名
        BRANCH=$(echo "$ORIGINAL_MSG" | grep -oE "branch '[^']+'" | head -1 | sed "s/branch '\\([^']*\\)'/\\1/")
        if [ -n "$BRANCH" ]; then
            echo "chore(Merge): 合并 ${BRANCH} 分支;" > "$COMMIT_MSG_FILE"
        fi
        exit 0
    fi

    # 处理普通 commit（非 merge）
    if [ "$COMMIT_SOURCE" = "message" ] || [ -z "$COMMIT_SOURCE" ]; then
        # 检测 vibe-kanban 格式: "NE: Description (vibe-kanban UUID)" 或 "NE：Description (vibe-kanban UUID)"
        if echo "$ORIGINAL_MSG" | grep -qE "^(NE:|NE：) .+ \(vibe-kanban [a-f0-9-]+\)$"; then
            # 提取 UUID
            UUID=$(echo "$ORIGINAL_MSG" | grep -oE "vibe-kanban [a-f0-9-]+")
            # 提取描述（去除 NE: / NE： 和 UUID 部分）
            DESC=$(echo "$ORIGINAL_MSG" | sed -E 's/^(NE:|NE：) //' | sed 's/ (vibe-kanban [a-f0-9-]+)$//' | sed 's/;$//')

            # 尝试根据描述推断类型（简单规则）
            TYPE="chore"
            SCOPE="General"

            if echo "$DESC" | grep -qiE "action|workflow|ci|test"; then
                TYPE="ci"
                SCOPE="Tests"
            elif echo "$DESC" | grep -qiE "document|文档"; then
                TYPE="feat"
                SCOPE="Documents"
            elif echo "$DESC" | grep -qiE "fix|修复|bug"; then
                TYPE="fix"
                SCOPE="Core"
            elif echo "$DESC" | grep -qiE "add|new|新增|实现"; then
                TYPE="feat"
                SCOPE="Feature"
            fi

            # 格式化为规范格式
            FORMATTED_MSG="${TYPE}(${SCOPE}): ${DESC} (${UUID});"
            echo "$FORMATTED_MSG" > "$COMMIT_MSG_FILE"
        fi
    fi
fi

exit 0
