#!/usr/bin/env bash
# Commit Message 格式验证
# 规范: type(Scope): description;

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 允许空提交（git commit --allow-empty-message）
if [ -z "$COMMIT_MSG" ]; then
    exit 0
fi

# 跳过 merge commit
if grep -q "^Merge" "$COMMIT_MSG_FILE" 2>/dev/null; then
    exit 0
fi

# 跳过 revert commit
if grep -q "^Revert" "$COMMIT_MSG_FILE" 2>/dev/null; then
    exit 0
fi

# 提取第一行（标题行）
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# 检测 vibe-kanban 格式并自动转换
# Feature: description (vibe-kanban XXX) -> feat(General): description (vibe-kanban XXX);
# Fix: description (vibe-kanban XXX) -> fix(General): description (vibe-kanban XXX);
if echo "$FIRST_LINE" | grep -qE "^(Feature|Fix|Bug|Enhancement|Refactor|Style|Docs|Test|Chore): .+\(vibe-kanban [^)]+\)"; then
    # 类型映射表
    case "$FIRST_LINE" in
        Feature:*)    NEW_TYPE="feat" ;;
        Enhancement:*) NEW_TYPE="feat" ;;
        Fix:*)        NEW_TYPE="fix" ;;
        Bug:*)        NEW_TYPE="fix" ;;
        Refactor:*)   NEW_TYPE="refactor" ;;
        Style:*)      NEW_TYPE="style" ;;
        Docs:*)       NEW_TYPE="docs" ;;
        Test:*)       NEW_TYPE="test" ;;
        Chore:*)      NEW_TYPE="chore" ;;
        *)            NEW_TYPE="feat" ;;
    esac

    # 提取内容（去除前缀类型和后缀 vibe-kanban ID）
    CONTENT=$(echo "$FIRST_LINE" | sed -E 's/^[A-Za-z]+: (.+)\(vibe-kanban [^)]+\).*/\1/' | sed 's/[[:space:]]*$//')

    # 提取 vibe-kanban task ID
    TASK_ID=$(echo "$FIRST_LINE" | sed -E 's/.*\(vibe-kanban ([^)]+)\).*/\1/')

    # 构建新的 commit message（追加分号）
    NEW_MSG="${NEW_TYPE}(General): ${CONTENT} (vibe-kanban ${TASK_ID});"

    # 写回文件（保留原有 body 内容）
    {
        echo "$NEW_MSG"
        echo "$COMMIT_MSG" | tail -n +2
    } > "$COMMIT_MSG_FILE"

    FIRST_LINE="$NEW_MSG"
fi

# 验证格式: type(Scope): description;
# 类型列表
TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
PATTERN="^($TYPES)\([A-Za-z0-9_-]+\): .+;$"

if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo ""
    echo "❌ Commit Message 格式不符合规范！"
    echo ""
    echo "当前格式: $FIRST_LINE"
    echo ""
    echo "正确格式: type(Scope): description;"
    echo ""
    echo "示例:"
    echo "  feat(Documents): 添加文件下载功能;"
    echo "  fix(Auth): 修复登录验证逻辑;"
    echo "  ci(Tests): 更新测试环境配置;"
    echo ""
    echo "类型列表: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo ""
    exit 1
fi

exit 0
